@page "/DeleteList"
@using Microsoft.EntityFrameworkCore
@using MyList.Data_Access
@using MyList.Models
@inject GiftListContext _context

@if (giftLists == null)
{
    <p><em>Loading...</em></p>
}
else
{
    <h2>My Lists</h2>

    <div>
        <label for="listName">Select List to Delete:</label>
        <select id="listName" @bind="selectedListName">
            <option value="">-- Select a list --</option>
            @foreach (var listName in existingListNames)
            {
                <option value="@listName">@listName</option>
            }
        </select>
        <button class="btn btn-danger" @onclick="DeleteEntireList" disabled="@(selectedListName == "")">Delete List</button>
    </div>

    <br>
    <br>

    <table class="table">
        <thead>
        <tr>
            <th>List Name</th>
            <th>Item Name</th>
            <th>Item Description</th>
            <th>Is Done</th>
            <th>Select</th>
        </tr>
        </thead>
        <tbody>
        @foreach (var group in giftLists.GroupBy(g => g.ListName))
        {
            @foreach (var gift in group)
            {
                <tr>
                    <td>@group.Key</td>
                    <td>@gift.GiftName</td>
                    <td>@gift.GiftDescription</td>
                    <td>@(gift.IsPurchased ? "Done" : "")</td>
                    <td><input type="checkbox" @bind="selectedItems[gift.Id]"/></td>
                </tr>
            }
        }
        </tbody>
    </table>

    <button class="btn btn-danger" @onclick="DeleteSelectedItems">Delete Selected Items</button>
}

@code {
    private List<GiftList> giftLists;
    private List<string> existingListNames = new();
    private string selectedListName = "";
    private Dictionary<int, bool> selectedItems = new();

    protected override async Task OnInitializedAsync()
    {
        giftLists = await _context.GiftLists.ToListAsync();

        foreach (var gift in giftLists)
        {
            selectedItems[gift.Id] = false;
        }

        existingListNames = await _context.GiftLists
            .Select(g => g.ListName)
            .Distinct()
            .ToListAsync();
    }

    private async Task DeleteSelectedItems()
    {
        var giftsToDelete = selectedItems.Where(kvp => kvp.Value).Select(kvp => kvp.Key).ToList();

        if (giftsToDelete.Any())
        {
            try
            {
                foreach (var giftId in giftsToDelete)
                {
                    var giftToDelete = await _context.GiftLists.FindAsync(giftId);
                    if (giftToDelete != null)
                    {
                        _context.GiftLists.Remove(giftToDelete);
                    }
                }

                await _context.SaveChangesAsync();

                // Refresh the list AND the dictionary
                giftLists = await _context.GiftLists.ToListAsync();
                selectedItems = giftLists.ToDictionary(g => g.Id, g => false); 

                StateHasChanged();
            }
            catch (Exception ex)
            {
                Console.WriteLine("Error deleting items: " + ex.Message);
            }
        }
    }

    private async Task DeleteEntireList()
    {
        try
        {
            var itemsToDelete = await _context.GiftLists.Where(g => g.ListName == selectedListName).ToListAsync();
            if (itemsToDelete.Any())
            {
                _context.GiftLists.RemoveRange(itemsToDelete);
                await _context.SaveChangesAsync();

                // Refresh the list and the dropdown
                giftLists = await _context.GiftLists.ToListAsync();
                existingListNames = await _context.GiftLists
                    .Select(g => g.ListName)
                    .Distinct()
                    .ToListAsync();

                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine("Error deleting list: " + ex.Message);
        }
    }
}